name: Publish Packages

on:
  push:
    branches:
      - main
    paths:
      - 'libs/document-engine-core/**'
      - 'libs/document-engine-angular/**'
      - 'tools/legacy-builder/**' # <-- Quan trá»ng: Trigger khi sá»­a builder
      - '.github/workflows/publish.yml'
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish both packages?'
        required: true
        default: 'true'

jobs:
  check-changes:
    runs-on: ubuntu-latest
    outputs:
      core-changed: ${{ steps.filter.outputs.core }}
      angular-changed: ${{ steps.filter.outputs.angular }}
      skip-publish: 'false' # Máº·c Ä‘á»‹nh lÃ  khÃ´ng skip
      is-manual: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for file changes
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            core:
              - 'libs/document-engine-core/**'
            angular:
              - 'libs/document-engine-angular/**'
              - 'tools/legacy-builder/**'

  publish:
    needs: check-changes
    runs-on: ubuntu-latest
    # Cháº¡y náº¿u cÃ³ thay Ä‘á»•i HOáº¶C lÃ  cháº¡y thá»§ cÃ´ng
    if: |
      needs.check-changes.outputs.core-changed == 'true' ||
      needs.check-changes.outputs.angular-changed == 'true' ||
      needs.check-changes.outputs.is-manual == 'true'

    permissions:
      contents: read
      id-token: write # Báº¯t buá»™c cho Trusted Publishing
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org/'
          scope: '@phuong-tran-redoc'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Root Dependencies
        run: pnpm install --frozen-lockfile

      - name: Clear Nx Cache
        run: pnpm nx clear-cache

      # --- BÆ¯á»šC 1: BUILD CORE (QUAN TRá»ŒNG: LUÃ”N CHáº Y KHI Cáº¦N PUBLISH Báº¤T Cá»¨ CÃI GÃŒ) ---
      # LÃ½ do: Angular cáº§n Core trong dist/ Ä‘á»ƒ build.
      - name: Build document-engine-core
        run: pnpm nx build document-engine-core

      # --- DEBUG: Kiá»ƒm tra xem Core Ä‘Ã£ build xong chÆ°a ---
      - name: Verify Core Build
        run: |
          echo "--- Checking CORE dist folder ---"
          ls -la dist/libs/document-engine-core
          cat dist/libs/document-engine-core/package.json

      # --- BÆ¯á»šC 2: BUILD ANGULAR (LEGACY) ---
      # Chá»‰ cháº¡y khi Angular thay Ä‘á»•i HOáº¶C Core thay Ä‘á»•i (Ä‘á»ƒ Ä‘á»“ng bá»™ version) HOáº¶C Manual
      - name: Build document-engine-angular (Legacy v14 Support)
        if: |
          needs.check-changes.outputs.angular-changed == 'true' ||
          needs.check-changes.outputs.core-changed == 'true' ||
          needs.check-changes.outputs.is-manual == 'true'
        run: |
          echo "ðŸ“¦ Installing Legacy Builder dependencies..."
          cd tools/legacy-builder
          npm ci

          echo "ðŸ”¨ Building Angular Library with Legacy Compiler..."
          npm run build

          echo "âœ… Build complete. Checking output..."
          ls -la ../../dist/libs/document-engine-angular-legacy

      # --- BÆ¯á»šC 3: PUBLISH CORE ---
      - name: Publish document-engine-core
        if: |
          needs.check-changes.outputs.core-changed == 'true' ||
          needs.check-changes.outputs.is-manual == 'true'
        # DÃ¹ng --provenance cho Trusted Publishing
        run: pnpm publish --filter @phuong-tran-redoc/document-engine-core --no-git-checks --provenance --access public

      # --- BÆ¯á»šC 4: PUBLISH ANGULAR ---
      - name: Publish document-engine-angular
        if: |
          needs.check-changes.outputs.angular-changed == 'true' ||
          needs.check-changes.outputs.core-changed == 'true' ||
          needs.check-changes.outputs.is-manual == 'true'
        working-directory: dist/libs/document-engine-angular-legacy
        # DÃ¹ng npm publish trá»±c tiáº¿p trong folder dist
        run: npm publish --provenance --access public
