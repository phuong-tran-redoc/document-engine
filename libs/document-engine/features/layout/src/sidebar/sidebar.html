<document-engine-sidebar
  #primarySidebarEl
  [mode]="mode()"
  [expandVariant]="expandVariant()"
  [state]="sidebarState()"
  (closeStart)="onSidebarStateChange('close')"
>
  <!-- Sidebar header -->
  <div slot="header">
    <div class="flex">
      <a
        [routerLink]="[route.HOME]"
        class="flex items-center justify-center gap-x-4 cursor-pointer p-2 rounded-lg w-full hover:bg-[var(--sidebar-accent)]"
        matRipple
      >
        <mat-icon>apartment</mat-icon>

        @if (expandVariant() === 'full') {
        <span class="flex flex-col items-start flex-1 gap-y-1">
          <span class="font-bold">Document Engine</span>
          <span>Dashboard</span>
        </span>
        }
      </a>

      <div #headerMenuTrigger="matMenuTrigger" [matMenuTriggerFor]="headerMenu" class="absolute top-0 right-0"></div>

      <mat-menu #headerMenu="matMenu" xPosition="after" yPosition="above" overlapTrigger="false" class="w-40">
        <button mat-menu-item>Item 1</button>
        <button mat-menu-item>Item 2</button>
      </mat-menu>
    </div>
  </div>

  <div slot="content" class="p-2">
    <div documentEngineSidebarGroup class="mb-4">
      <div documentEngineSidebarGroupLabel>Essentials</div>

      <ul documentEngineSidebarMenu>
        @for (item of items(); track item.id) { @switch (item.type) {
        <!-- Normal Items -->
        @case ('normal') {
        <li documentEngineSidebarMenuItem>
          <a documentEngineSidebarMenuButton [routerLink]="item.url" routerLinkActive>
            @if (item.icon) {
            <mat-icon class="document-engine-icon--base">{{ item.icon }}</mat-icon>
            }
            <span>{{ item.name }}</span>
          </a>
        </li>
        }

        <!-- Items with submenu -->
        @case ('collapsible') { @switch (expandVariant()) { @case ('compact') {
        <li documentEngineSidebarMenuItem>
          <button documentEngineSidebarMenuButton [routerLink]="item.url" routerLinkActive>
            @if (item.icon) {
            <mat-icon class="document-engine-icon--base">{{ item.icon }}</mat-icon>
            }
            <span>{{ item.name }}</span>
          </button>
        </li>
        } @default {
        <mat-expansion-panel
          [expanded]="item.isActive"
          hideToggle
          #collapsible="matExpansionPanel"
          class="group/collapsible !shadow-none"
        >
          <mat-expansion-panel-header class="!p-0 !h-auto">
            <li documentEngineSidebarMenuItem class="w-full">
              <button documentEngineSidebarMenuButton class="w-full text-left">
                @if (item.icon) {
                <mat-icon class="document-engine-icon--base min-w-5">{{ item.icon }}</mat-icon>
                }

                <span>{{ item.name }}</span>

                <mat-icon
                  class="ml-auto transition-transform duration-200 ease-in-out document-engine-icon--base"
                  [class.rotate-90]="collapsible.expanded"
                >
                  chevron_right
                </mat-icon>
              </button>
            </li>
          </mat-expansion-panel-header>

          <ul documentEngineSidebarMenuSub>
            @for (sub of item.items; track sub.id) {
            <li documentEngineSidebarMenuSubItem>
              <a documentEngineSidebarMenuSubButton [routerLink]="sub.url" routerLinkActive>
                @if (sub.icon) {
                <mat-icon class="document-engine-icon--base">{{ sub.icon }}</mat-icon>
                }
                <span>{{ sub.name }}</span>
              </a>
            </li>
            }
          </ul>
        </mat-expansion-panel>
        } } } } }
      </ul>
    </div>

    <ng-template #renderNodes let-nodes let-depth="depth">
      @for (node of nodes; track node.id) { @if (!!node.items?.length) {
      <mat-expansion-panel hideToggle #exp="matExpansionPanel" class="group/collapsible !shadow-none">
        <mat-expansion-panel-header class="!p-0 !h-auto">
          @if (depth === 0) {
          <li documentEngineSidebarMenuItem class="w-full">
            <button documentEngineSidebarMenuButton class="w-full text-left">
              @if (node.icon) {
              <mat-icon class="document-engine-icon--base min-w-5">{{ node.icon }}</mat-icon>
              }
              <span>{{ node.name }}</span>
              <mat-icon
                class="ml-auto transition-transform duration-200 ease-in-out document-engine-icon--base"
                [class.rotate-90]="exp.expanded"
              >
                chevron_right
              </mat-icon>
            </button>
          </li>
          } @else {
          <li documentEngineSidebarMenuSubItem class="w-full">
            <a documentEngineSidebarMenuSubButton class="w-full">
              <span>{{ node.name }}</span>
              <mat-icon
                class="ml-auto transition-transform duration-200 ease-in-out document-engine-icon--base"
                [class.rotate-90]="exp.expanded"
              >
                chevron_right
              </mat-icon>
            </a>
          </li>
          }
        </mat-expansion-panel-header>

        <ul documentEngineSidebarMenuSub>
          <ng-container
            [ngTemplateOutlet]="renderNodes"
            [ngTemplateOutletContext]="{ $implicit: node.items, depth: depth + 1 }"
          ></ng-container>
        </ul>
      </mat-expansion-panel>
      } @else { @if (depth === 0) {
      <li documentEngineSidebarMenuItem>
        <a documentEngineSidebarMenuButton [routerLink]="node.url" [isActive]="node.isActive ?? false">
          <span>{{ node.name }}</span>
        </a>
      </li>
      } @else {
      <li documentEngineSidebarMenuSubItem>
        <a documentEngineSidebarMenuSubButton [routerLink]="node.url" [isActive]="node.isActive ?? false">
          <span>{{ node.name }}</span>
        </a>
      </li>
      } } }
    </ng-template>
  </div>

  <!-- Sidebar footer -->
  <div slot="footer" class="flex">
    <button
      class="flex items-center justify-center gap-x-4 cursor-pointer p-2 rounded-lg w-full hover:bg-[var(--sidebar-accent)]"
      matRipple
    >
      <!-- (click)="menuTrigger.openMenu()" -->
      <document-engine-avatar [items]="avatar" (avatarClick)="onAvatarClick($event)"></document-engine-avatar>

      <!-- TODO: Get from user service -->
      @if (expandVariant() === 'full') {
      <span class="flex flex-col items-start flex-1 gap-y-1">
        <span class="font-bold">Phuong Tran</span>
        <span>phuong.tran&#64;realestatedoc.co</span>
      </span>

      <!-- <mat-icon class="transition-transform duration-200 ease-in-out" [class.-rotate-90]="menuTrigger.menuOpen">
            keyboard_arrow_down
        </mat-icon> -->
      }
    </button>

    <div #menuTrigger="matMenuTrigger" [matMenuTriggerFor]="menu" class="absolute bottom-0 right-0"></div>

    <mat-menu #menu="matMenu" xPosition="after" yPosition="above" overlapTrigger="false" class="w-40">
      <button mat-menu-item (click)="openProfile()">Profile</button>
      <button mat-menu-item (click)="logout()">Logout</button>
    </mat-menu>
  </div>

  <!-- Content -->
  <main class="relative flex flex-col w-full h-full">
    <ng-container [cdkPortalOutlet]="header()"></ng-container>

    <router-outlet></router-outlet>
  </main>
</document-engine-sidebar>
